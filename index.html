<script>
    let currentDate = new Date();
    let rosterData = [];  // Store the full roster data
    let currentRoster = [];  // Store the roster for the current day

    // List of all the department files in the 'calldata' folder (you must manually list these here)
    const departmentFiles = [
        'calldata/Burns and Plastic Surgery.json', 'calldata/Cardio Vascular & Thoracic Surgery.json'
        // Add more department JSON files here if needed
    ];

    // Fetch each department JSON file and combine them into rosterData
    Promise.all(departmentFiles.map(file => fetch(file).then(response => response.json())))
        .then(departmentData => {
            rosterData = departmentData;  // Store all the department data
            updateTableForDate(currentDate); // Display the data for the current date
        })
        .catch(err => {
            console.error('Error fetching JSON files:', err);
        });

    function formatDate(date) {
        const day = date.getDate();
        const month = date.getMonth() + 1; // Months are 0-based
        const year = date.getFullYear().toString().slice(-2); // Get last 2 digits of the year
        return `${day < 10 ? '0' + day : day}-${month < 10 ? '0' + month : month}-${year}`;
    }

    function getDayOfWeek(date) {
        const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        return days[date.getDay()];
    }

    function getCurrentDayDisplay(date) {
        const dayOfWeek = getDayOfWeek(date);
        const formattedDate = formatDate(date);
        return `${dayOfWeek}, ${formattedDate}`;
    }

    function updateTableForDate(date) {
        const dateString = formatDate(date);
        const dayOfWeek = getDayOfWeek(date);

        // Update the current day display with the new format
        document.getElementById('currentDay').textContent = `On-Call - ${getCurrentDayDisplay(date)} (Full Day Duty)`;

        // Clear existing table rows
        const tableBody = document.getElementById('callTable').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = ''; 

        let foundData = false;

        // Loop through all department data
        rosterData.forEach(department => {
            const dutyRoster = department.DutyRoster.find(item => item.Date === dateString && item.Day === dayOfWeek);
            
            if (dutyRoster) {
                foundData = true;
                const newRow = tableBody.insertRow();
                const departmentCell = newRow.insertCell();
                departmentCell.textContent = department.Department;

                const firstCallCell = newRow.insertCell();
                firstCallCell.innerHTML = `<strong>${dutyRoster.FirstCall.Name}</strong><br><span class="phone-number" data-phone="${dutyRoster.FirstCall.Number}">${dutyRoster.FirstCall.Number}</span>`;

                const secondCallCell = newRow.insertCell();
                secondCallCell.innerHTML = `<strong>${dutyRoster.SecondCall.Name}</strong><br><span class="phone-number" data-phone="${dutyRoster.SecondCall.Number}">${dutyRoster.SecondCall.Number}</span>`;
            }
        });

        if (!foundData) {
            tableBody.innerHTML = '<tr><td colspan="3">No data available for the selected date</td></tr>';
        }

        // Add click event for phone numbers to initiate a call
        document.querySelectorAll('.phone-number').forEach(cell => {
            cell.addEventListener('click', function() {
                const phoneNumber = this.getAttribute('data-phone');
                window.location.href = `tel:${phoneNumber}`;
            });
        });
    }

    // When the "Update Date" button is clicked
    document.getElementById('updateDateButton').addEventListener('click', function() {
        const dateInput = document.getElementById('datePicker').value;
        if (dateInput) {
            const selectedDate = new Date(dateInput);
            updateTableForDate(selectedDate);
        } else {
            alert('Please select a date');
        }
    });
</script>
